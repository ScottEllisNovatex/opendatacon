<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
      $(function() {
          $("#common_content").load("common.html");
      });
    </script>
  </head>

  <body>

    <script>
      $(document).ready(function() {
          const command = new URL(window.location.href).searchParams.get("command");
          initialize(set_data);
      });

      function initialize(callback) {
          var g_data = null;
          const url = "/DataPorts/List";
          $.post(url, {})
              .done(function(data) {
                  var ports = [];
                  for (var key in Object.keys(data["Items"])) {
                      ports.push(data["Items"][key]);
                      const sim = /Sim*/;
                      var result = data["Items"][key].match(sim);
                      if (result) {
                          const url = "/DataPorts/Configuration";
                          $.post(url, {Target : data["Items"][key]})
                              .done(function (data) {
                                  var analogs = [];
                                  var binaries = [];
                                  if (data["ConfigOverrides"]["Analogs"] != null)
                                      analogs = get_indexes(data["ConfigOverrides"]["Analogs"]);
                                  if (data["ConfigOverrides"]["Binaries"] != null)
                                      binaries = get_indexes(data["ConfigOverrides"]["Binaries"]);
                                  callback(ports, analogs, binaries);
                              });
                      }
                  }
              });
      }

      function set_data(ports, analogs, binaries) {
          console.log(ports);
          console.log(analogs);
          console.log(binaries);
      }

      function get_indexes(data) {
          indexes = [];
          for (key in Object.keys(data)) {
              if (data[key]["Range"] != null) {
                  var start = 0;
                  var stop = 0;
                  if (data[key]["Range"]["Start"] != null && data[key]["Range"]["Stop"] != null) {
                      start = parseInt(data[key]["Range"]["Start"]);
                      stop = parseInt(data[key]["Range"]["Stop"]);

                      for (var i = start; i <= stop; ++i)
                          indexes.push(i.toString());
                  }
              }

              if (data[key]["Index"] != null) {
                  indexes.push(data[key]["Index"]);
              }
          }

          return indexes;
      }
    </script>
  </body>
</html>
