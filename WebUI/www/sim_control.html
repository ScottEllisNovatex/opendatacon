<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenDataCon</title>

    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel = "stylesheet" href="/node_modules/bootstrap_select/dist/css/bootstrap-select.css" />

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/popper/dist/umd/popper.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src= "/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src= "/node_modules/bootstrap_select/dist/js/bootstrap-select.min.js"></script>

    <style>
      .modal.simcontrol .modal-dialog {
          width:1240px;
          /* For responsive */
          max-width:100%;
          max-height:100%;
      }

      <span style="white-space: pre-line">@Model.CommentText</span>
    </style>

    <script>
      $(function() {
          $("#common_content").load("common.html");
          $('select').selectpicker();
      });
    </script>
  </head>

  <body>

    <div class="container">
      <label for="command_text_box">Sim Control Command:</label>
      <input type="text" class="form-control" id="command_text_box">
      <br>

      <div class="row">

        <div class="col-sm-4">
          <select class="selectpicker" multiple data-live-search="true" id="ports_select" title="Ports">
          </select>
        </div>

        <div class="col-sm-4">
          <div class="dropdown" id="point_type_dropdown">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
              Point Type
            </button>

            <div class="dropdown-menu">
              <a class="dropdown-item" onclick="set_point_type('Analog')">Analog</a>
              <a class="dropdown-item" onclick="set_point_type('Binary')">Binary</a>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <select class="selectpicker" multiple data-live-search="true" id="index_select" title="Indexes">
          </select>
        </div>

      </div>

      <br>
      <label for="value_text_box">Value:</label>
      <input type="text" class="form-control " id="value_text_box" onchange="set_value(value)">
      <br>
      <div class="alert alert-info clearfix">
        <button type="button" class="btn btn-primary btn-block" onclick="execute_command()">Execute</button>
      </div>
      <div class="alert alert-info clearfix">
        <button type="button" class="btn btn-secondary btn-block" onclick="clear_logs()">Clear</button>
      </div>

    </div>

    <div class="container">
      <pre>
        <div id="tcp_logs"></div>
      </pre>
    </div>

    <script>
      var ganalogs = [];
      var gbinaries = [];
      var gport = null;
      var gpoint_type = null;
      var gindex = null;
      var gvalue = null;
      var gcommand = null;
      var gcommand_text = null;
      var grefresh_time = 2000;

      $(document).ready(function() {
          gcommand = new URL(window.location.href).searchParams.get("command");
          gcommand_text = gcommand;
          document.getElementById("command_text_box").value = gcommand;
          build_command();

          const url = "/OpenDataCon/set_loglevel trace";
          $.post(url, {})
              .done(function(data) {
                  console.log("Rakesh trace log is on now");
              });

          window.setInterval(function() { get_tcp_logs(); }, grefresh_time);
          initialize(set_data);
      });

      function get_tcp_logs() {
          const url = "/OpenDataCon/tcp_logs_on";
          $.post(url, {})
              .done(function(data) {
                  document.getElementById("tcp_logs").innerHTML += data["tcp_data"];
              });
      }

      function initialize(callback) {
          var g_data = null;
          const url = "/DataPorts/List";
          $.post(url, {})
              .done(function(data) {
                  var ports = [];
                  for (var key in Object.keys(data["Items"])) {
                      ports.push(data["Items"][key]);
                      const sim = /Sim*/;
                      var result = data["Items"][key].match(sim);
                      if (result) {
                          const url = "/DataPorts/Configuration";
                          $.post(url, {Target : data["Items"][key]})
                              .done(function (data) {
                                  var analogs = [];
                                  var binaries = [];
                                  if (data["ConfigOverrides"]["Analogs"] != null)
                                      analogs = get_indexes(data["ConfigOverrides"]["Analogs"]);
                                  if (data["ConfigOverrides"]["Binaries"] != null)
                                      binaries = get_indexes(data["ConfigOverrides"]["Binaries"]);
                                  callback(ports, analogs, binaries);
                              });
                      }
                  }
              });
      }

      function set_data(ports, analogs, binaries) {
          var options = [];
          options.push("<option>All</option>");
          ports.forEach(function (item) {
              var option = "<option>" + item + "</option>"
              options.push(option);
          });

          $('#ports_select').html(options);
          $('#ports_select').selectpicker('refresh');

          ganalogs = analogs;
          gbinaries = binaries;
      }

      function get_indexes(data) {
          indexes = [];
          for (key in Object.keys(data)) {
              if (data[key]["Range"] != null) {
                  var start = 0;
                  var stop = 0;
                  if (data[key]["Range"]["Start"] != null && data[key]["Range"]["Stop"] != null) {
                      start = parseInt(data[key]["Range"]["Start"]);
                      stop = parseInt(data[key]["Range"]["Stop"]);

                      for (var i = start; i <= stop; ++i)
                          indexes.push(i.toString());
                  }
              }

              if (data[key]["Index"] != null) {
                  indexes.push(data[key]["Index"].toString());
              }
          }

          return indexes;
      }

      function set_point_type(point_type) {
          var indexes = [];
          gpoint_type = point_type;
          if (point_type == "Analog")
              indexes = ganalogs;
          if (point_type == "Binary")
              indexes = gbinaries;

          var options = [];
          options.push("<option>All</option>");
          indexes.forEach(function (item) {
              var option = "<option>" + item + "</option>"
              options.push(option);
          });

          $('#index_select').html(options);
          $('#index_select').selectpicker('refresh');

          build_command();
      }

      function clear_logs() {
          document.getElementById("tcp_logs").innerHTML = "";
      }

      function execute_command() {
          console.log("Rakesh execute this command mate");
      }

      function set_value(val) {
          gvalue = val;
          build_command();
      }

      function build_command() {
          gcommand_text = gcommand + " " + gport + " " + gpoint_type + " " + gindex + " " + gvalue;
          document.getElementById("command_text_box").value = gcommand_text;
      }

      $('#ports_select').on('changed.bs.select', function (e, index, new_value, old_value) {
          var selected = $(e.currentTarget).val();
          selected = selected.join(",");
          console.log(selected);
          if (selected.includes("All")) {
              gport = ".*";
          } else {
              gport = selected;
          }

          build_command();
      });

      $('#index_select').on('changed.bs.select', function (e, index, new_value, old_value) {
          var selected = $(e.currentTarget).val();
          selected = selected.join(",");
          if (selected.includes("All")) {
              gindex = ".*";
          } else {
              gindex = selected;
          }

          build_command();
      });
    </script>
  </body>
</html>
